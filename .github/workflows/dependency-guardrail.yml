name: Dependency Guardrail

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-socket:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for dependency file changes
        id: deps
        run: |
          # Get list of changed files
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Define dependency file patterns (one per line for clarity)
          DEP_PATTERNS="package.json|package-lock.json|yarn.lock|pnpm-lock.yaml"
          DEP_PATTERNS="$DEP_PATTERNS|requirements.txt|requirements-dev.txt|pyproject.toml|poetry.lock"
          DEP_PATTERNS="$DEP_PATTERNS|Pipfile|Pipfile.lock|setup.py|setup.cfg"
          DEP_PATTERNS="$DEP_PATTERNS|Cargo.toml|Cargo.lock|go.mod|go.sum|Gemfile|Gemfile.lock"

          # Check if any dependency files changed
          MATCHED=$(echo "$CHANGED" | grep -E "$DEP_PATTERNS" || true)

          if [ -n "$MATCHED" ]; then
            echo "deps_changed=true" >> $GITHUB_OUTPUT
            echo "Changed dependency files:"
            echo "$MATCHED"
          else
            echo "deps_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify Socket check in PR description
        if: steps.deps.outputs.deps_changed == 'true'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if echo "$PR_BODY" | grep -qE "SOCKET_CHECK:|/socket summary"; then
            echo "✓ Socket check documentation found in PR description"
            exit 0
          fi

          echo "::error::Dependency files were modified but no Socket check found in PR description."
          echo ""
          echo "═══════════════════════════════════════════════════════════════"
          echo "  This PR modifies dependency files."
          echo "  Please run /socket and document the results."
          echo "═══════════════════════════════════════════════════════════════"
          echo ""
          echo "Steps to fix:"
          echo "1. Run /socket on the changed/added dependencies"
          echo "2. Add the results to your PR description"
          echo ""
          echo "Example format to add to PR description:"
          echo ""
          echo "  SOCKET_CHECK: clean"
          echo "  Package: lodash@4.17.21"
          echo "  Issues: 0 critical, 0 moderate"
          echo "  Details: none"
          echo ""
          echo "Or for multiple packages:"
          echo ""
          echo "  SOCKET_CHECK: summary"
          echo "  Packages checked: 3"
          echo "  Results: 3 clean, 0 moderate, 0 critical"
          echo ""
          exit 1
